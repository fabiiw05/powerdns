---
- name: Install PowerDNS
  hosts: powerdns

  pre_tasks:

    - name: apt-get update
      ansible.builtin.apt:
        pkg:
          - mariadb-server
          - python3-mysqldb
        update_cache: yes

    - name: Check login MariaDB
      failed_when: false
      register: file_ck
      community.mysql.mysql_info:
        login_user: root
        login_password: "{{ powerdns_mysql_root_password }}"
        filter: version

    - name: Set DB Password
      block:
        - name: Change the authentication plugin of MySQL root user to mysql_native_password
          shell: mysql -u root -e 'UPDATE mysql.user 
                 SET plugin="mysql_native_password" 
                 WHERE user="root" 
                 AND host="localhost"'

        - name: Flush Privileges
          shell: mysql -u root -e 'FLUSH PRIVILEGES'

        - name: Set mariadb root Password
          mysql_user:
            login_host: 'localhost'
            login_user: 'root'
            login_password: ''
            name: 'root'
            password: '{{ powerdns_mysql_root_password }}'
            state: present 

      when: file_ck.version is not defined

  roles:
    - role: powerdns.pdns
      pdns_user: "root"
      pdns_group: "root"
      pdns_mysql_packages:
       - mariadb-client
